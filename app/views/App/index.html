{{template "header.html" .}}

<script src="/public/CodeMirror/lib/codemirror.js"></script>
<script src="/public/CodeMirror/mode/xml/xml.js"></script>
<script src="/public/CodeMirror/mode/javascript/javascript.js"></script>
<script src="/public/CodeMirror/mode/css/css.js"></script>
<script src="/public/CodeMirror/mode/htmlmixed/htmlmixed.js"></script>
<script src="/public/CodeMirror/mode/python/python.js"></script>
<script src="/public/CodeMirror/addon/edit/matchbrackets.js"></script>

<script src="/public/CodeMirror/doc/activebookmark.js"></script>
<link rel=stylesheet href="/public/CodeMirror/lib/codemirror.css">
<script src="/public/js/jquery.js"></script>

<style>
  .CodeMirror { height: 200px; border: 1px solid #ddd; background: #fdf6e3; color:#657b83;text-shadow:#eee8d5 0 1px;}
  .CodeMirror-scroll { max-height: 200px; }
  .CodeMirror pre { padding-left: 7px; line-height: 1.25; }
</style>

<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">New execution</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>

    <!-- /.row -->
    <div class="row">
        <!-- /.col-lg-8 -->

        <!----- Run execute  ----->
        <div class="col-lg-12" id=run_div style="padding:0px;">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title"><i class="fa fa-clock-o fa-fw"></i>New script</h3>
              </div>
                <div class="panel-body">
                  <div>
                    <div class="form-group">
                      <label for="label">Execution script</label>
                      <textarea id=run_area>#!/bin/bash </textarea>
                    </div>
                    <p class="buttons">
                      <button id=run-btn class="btn btn-primary">Run</button>
                    </p>
                  </div>
                </div>
              </div>
          </div>

        </div>
        <div class="row">

          <!----- Output execute  ----->
          <div class="panel panel-default">
              <div class="panel-heading">
                  <h3 class="panel-title"><i class="fa fa-clock-o fa-fw"></i>Output execution</h3>
              </div>
              <div class="panel-body">
                <div>
                  <div class="form-group">
                    <label for="label">Execution script</label>
                      <textarea id=output_area>
                      </textarea>
                  </div>
                </div>
              </div>
          </div>

        </div>
        <div class="row">

          <div class="panel panel-default" id=form class="col-lg-12" >
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-clock-o fa-fw"></i>Registrer execution</h3>
            </div>
            <div class="panel-body">
              <div>
                <div class="form-group">
                  <form action="{{ url "Executions.Create"}}" method="POST">
                    {{with $field := field "execution.Name" .}}
                    <div class="form-group" >
                      <label for="name">Execution name</label>
                      <input required id="execName" name="{{$field.Name}}" type="text" class="form-control disabled" value="{{$field.Flash}}">
                    </div>
                    {{end}}
                    <p class="buttons">
                      <input type="submit" class="btn btn-primary disabled" value="Save execution">
                    </p>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

    </div>
    <!-- /.row -->
</div>
<!-- /#page-wrapper -->

<script>
  var run_editor = CodeMirror.fromTextArea(document.getElementById("run_area"), {
    lineNumbers: true,
    mode: "python",
    matchBrackets: true
  });

  var out_editor = CodeMirror.fromTextArea(document.getElementById("output_area"), {
    matchBrackets: true,
    readOnly : true
  });

  $("#run-btn").click(function(){
    $.getJSON( "/execution/run?script=" + run_editor.getValue(), function(data) {
      if (data["success"] == false) {
        alert(data["error"])
      } else {

        out_editor.refresh()
        var socket = new WebSocket('ws://localhost:9000/websocket/room?room_name=' + data["uuid"])

             // Message received on the socket
        output = ""
        socket.onmessage = function(event) {
          if (JSON.parse(event.data) == "end_" + data["uuid"]) {
            run__exec_editor.setValue(run_editor.getValue())
            run__exec_editor.refresh()
          } else {
            output += JSON.parse(event.data)
            out_editor.setValue(output)
          }
        }
      }
    });
  });
</script>


{{template "footer.html" .}}
