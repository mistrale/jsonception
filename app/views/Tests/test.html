{{set_test_uuid . }}
<div class="panel panel-info" id=panel_test_infos_{{.Uuid}}>
  <div class="panel-heading">
    {{if eq .TestID 0}}
    <!-- <h3 class="panel-title"><i>Register test</i></h3> -->
    <h4 class="panel-title">
      <a data-toggle="collapse" id=collapser_test_{{.Uuid}} style="background-color:transparent;">Register test</a>
    </h4>
    <!-- <a data-toggle="collapse" class="fa fa-clock-o fa-fw" href="#collapse1">Registrer test</a> -->
    {{else}}
    <h4 class="panel-title">
      <a data-toggle="collapse" href=collapse_test_{{.Uuid}} id=collapser_test_{{.Uuid}} data-parent="#accordion" style="background-color:transparent;">{{.Name}}</a>
    </h4>
    {{end}}
      <!-- <h3 class="panel-title"><i ></i></h3> -->
  </div>
  {{if eq .TestID 0}}
  <div id="collapse_test_{{.Uuid}}" class="panel-collapse collapse in">
  {{else}}
  <div id="collapse_test_{{.Uuid}}" class="panel-collapse collapse">
  {{end}}
    <div class="panel-body">
      <div class="row">
        <div class="col-lg-6">
          <div>
            <div class="form-group">
              <div class="form-group" >
                <label for="ExecutionID" style="display:none;"></label>
                <input required id="execIDinput" type="hidden">
              </div>
              <div class="form-group" >
                <label for="test_name">Test name</label>
                <input required id="test_name_{{.Uuid}}" type="text" class="form-control" value="{{.Name}}">
              </div>
              <div class="form-group">
                <label for="path_file">Log ref event path file</label>
                <input required id="log_event_file_{{.Uuid}}" value="{{.PathLogFile}}" type="text" class="form-control"></input>
              </div>
              <div class="form-group">
                <label for="path_file">Log test event path file</label>
                <input required id="log_event_ref_file_{{.Uuid}}" value="{{.PathRefFile}}" type="text" class="form-control"></input>
              </div>
              <div class="form-group" >
                <div class="form-group" >
                  <label for="config">Add config json file</label>
                  <input required id="config_script" type="hidden">
                </div>
                <textarea id="config_area_{{.Uuid}}" class="config_area">{{.Config}}</textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6" id="exec_form_{{.Uuid}}">
          <div class="form-group"  >
            <label for="script">Add an execution</label>
            <select class="form-control" id=select_exec_{{.Uuid}}>
              <option val="0">Choose an execution</option>

            </select>
          </div>
            {{template "Executions/execution.html" .Execution}}
      <!-- NE PAS OUBLIER LES EXECUTIONS -->
        </div>
      </div>
      <!-- output de test -->
      <div class="row">
        <div class="col-lg-12">
          <div class="panel panel-warning" id=panel_test_run_{{.Uuid}} style="display:none; margin-top:20px;">
            <div class="panel-heading">
              <h3 class="panel-title"><i class="fa fa-clock-o fa-fw"></i>{{.Name}} run</h3>
            </div>
            <div class="panel-body">
              <div class="row">
                <div  class="col-sm-12">
                  <div class="form-group">
                    <label>Output execution</label>
                    <textarea  id="output_script_area_{{.Uuid}}"></textarea>
                  </div>
                </div>
              </div>
              <div class="row">
                <div  class="col-sm-6">
                  <div class="form-group">
                    <label>Log reference</label>
                    <textarea  id="event_ref_area_{{.Uuid}}"></textarea>
                  </div>
                </div>
                <div  class="col-sm-6">
                  <div class="form-group">
                    <label>Log test</label>
                    <textarea id="event_log_area_{{.Uuid}}"></textarea>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <ul class="list-group">
                    <li id=save_test_run_error_{{.Uuid}}  style="display:none;" class="list-group-item list-group-item-danger"></li>
                    <li id=save_test_run_success_{{.Uuid}}  style="display:none;" class="list-group-item list-group-item-success"></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- history  -->
      <div class="row" style="margin-top:20px;">
        <div class="col-lg-12">
          <div class="panel panel-warning" id=history_panel_{{.Uuid}} style="display:none;">
              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" href="#history_collapse_{{.Uuid}}"  style="background-color:transparent;">History</a>
                </h4>
              </div>
              <div id="history_collapse_{{.Uuid}}" class="panel-collapse collapse in">
                <div class="panel-body" id=history_panel_body_{{.Uuid}}></div>
              </div>
            </div>
        </div>
      </div>

    </div>
    <div class="panel-footer">
      <div class="row">
        <div class="col-lg-12">
          <div class="buttons">
            <button id=save_test_btn_{{.Uuid}} class="save_test_btn btn btn-primary" style="display:none;">Save</button>
            <button id=create_test_btn_{{.Uuid}} class="create_test_btn btn btn-primary">Create</button>
            <button id=run_test_btn_{{.Uuid}} class="run_test_btn btn btn-success">Run</button>
            <button id=delete_test_btn_{{.Uuid}} class="delete_test_btn btn btn-danger">Delete</button>
            <button id=exit_test_btn_{{.Uuid}} class="exit_test_run_btn btn btn-danger" style="display:none;">Exit run mode</button>
            <button id=history_test_btn_{{.Uuid}} class="history_test_btn btn btn-warning">See history</button>
          </div>
          <ul class="list-group">
            <li id=save_test_error_{{.Uuid}} style="display:none;" class="list-group-item list-group-item-danger"></li>
            <li id=save_test_success_{{.Uuid}} style="display:none;"  class="list-group-item list-group-item-success"></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<style>

</style>

<script>
var executionIDs = {};
var execUUIDs = {}
var array

var config_editor = {}

var event_log_editor= {}
var event_ref_editor = {}
var output_script_test = {}

//executionIDs[this.id] = 0

// load at beginning
$(document).ready(function() {
  exec_uuid = $("#exec_form_{{.Uuid}} .panel_exec" + " a").attr("id").split("_")[2]

  execUUIDs[{{.Uuid}}] = exec_uuid
  executionIDs[{{.Uuid}}] = {{.ExecutionID}}

  output_script_test[{{.Uuid}}] = CodeMirror.fromTextArea(document.getElementById("output_script_area_{{.Uuid}}"), {
    matchBrackets: true,
    theme:"mdn-like",
    lineNumbers: true,
    styleActiveLine:true
    });

  event_ref_editor[{{.Uuid}}] = CodeMirror.fromTextArea(document.getElementById("event_ref_area_{{.Uuid}}"), {
  matchBrackets: true,
  theme:"mdn-like",
  lineNumbers: true,
  styleActiveLine:true,
  readOnly : true,
  mode : "javascript",
  });

  event_log_editor[{{.Uuid}}] = CodeMirror.fromTextArea(document.getElementById("event_log_area_{{.Uuid}}"), {
  matchBrackets: true,
  theme:"mdn-like",
  lineNumbers: true,
  styleActiveLine:true,
  readOnly : true,
  mode : "javascript",
  });

  config_editor[{{.Uuid}}] = CodeMirror.fromTextArea(document.getElementById("config_area_{{.Uuid}}"), {
  matchBrackets: true,
  theme:"mdn-like",
  mode : "javascript",
  lineNumbers: true,
  styleActiveLine:true
  });

  if (!array) {
    $.ajax({
      dataType: "json",
      url: "http://localhost:9000/execution",
      success: function (data) {
        array = data["response"]
        $.each(array, function(k,v){
          $('#select_exec_{{.Uuid}}').append($('<option>', {
                value : v["executionID"],
                text: v["name"]
              }))
          });
        }
    });
  } else {
    $.each(array, function(k,v){
      console.log("lol : " + v)
      $('#select_exec_{{.Uuid}}').append($('<option>', {
            value : v["executionID"],
            text: v["name"]
          }))
      });
  }


  if ({{.ExecutionID}} == 0) {
    $('#collapse_exec_' + execUUIDs[{{.Uuid}}]).css({"display":"none"});
  }

  $('#select_exec_{{.Uuid}}').on('change', function() {
    var value = $('#select_exec_{{.Uuid}} :selected').text()
    function getElement(element) {
      console.log(element.name)
      return element.name == value;
    }
    elem = array.find(getElement)
    if (!elem) {
      $('#collapse_exec_' + execUUIDs[{{.Uuid}}]).css({"display":"none"});
      script_editor[execUUIDs[{{.Uuid}}]].setValue("")
      output_script_editor[execUUIDs[{{.Uuid}}]].setValue("")
      $("#exec_name_" + execUUIDs[{{.Uuid}}]).attr("value","")
      $("#create_btn_" + execUUIDs[{{.Uuid}}]).show()
      executionIDs[{{.Uuid}}] = 0
    } else {
      $('#collapse_exec_' + execUUIDs[{{.Uuid}}]).css({"display":"inherit"});
      script_editor[execUUIDs[{{.Uuid}}]].setValue(elem.script)
      script_editor[execUUIDs[{{.Uuid}}]].refresh()
      output_script_editor[execUUIDs[{{.Uuid}}]].setValue("")
      $("#exec_name_" + execUUIDs[{{.Uuid}}]).attr("value", elem.name)
      $("#create_btn_" + execUUIDs[{{.Uuid}}]).hide()
      executionIDs[{{.Uuid}}] = elem.executionID
    }
  });

  $("#collapser_test_{{.Uuid}}").on('click', function() {
    $("#collapse_test_{{.Uuid}}").toggle()
    console.log("uuid : " + {{.Uuid}})
    if ({{.ExecutionID}} != 0) {
      $("#select_exec_{{.Uuid}}").val({{.ExecutionID}});
      $('#collapse_exec_' + execUUIDs[{{.Uuid}}]).css({"display":"inherit"});
    }
    config_editor[{{.Uuid}}].refresh()
    output_script_test[{{.Uuid}}].refresh()
    script_editor[execUUIDs[{{.Uuid}}]].setValue({{.Execution.Script}})
    script_editor[execUUIDs[{{.Uuid}}]].refresh()
    output_script_editor[execUUIDs[{{.Uuid}}]].refresh()
  });

  $("#create_test_btn_{{.Uuid}}").click(function() {
      $("#save_test_error_{{.Uuid}}").hide()
      $("#save_test_success_{{.Uuid}}").hide()

      var data = {
        name : $("#test_name_{{.Uuid}}").val(),
        config : config_editor[{{.Uuid}}].getValue(),
        path_log : $("#log_event_file_{{.Uuid}}").val(),
        log_events : $("#log_event_ref_file_{{.Uuid}}").val(),
        executionID : executionIDs[{{.Uuid}}],
      };

          // construct an HTTP request
        var xhr = new XMLHttpRequest();
        xhr.open("POST", 'http://localhost:9000/test/', true);
        xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

        // send the collected data as JSON
        xhr.send(JSON.stringify(data));

        xhr.onloadend = function () {
          response = JSON.parse(xhr.responseText);
          if (response["status"] != true) {

            $("#save_test_error_{{.Uuid}}").slideDown()
            $("#save_test_error_{{.Uuid}}").text(response["message"])
          } else {
            $("#save_test_success_{{.Uuid}}").slideDown()
            $("#save_test_success_{{.Uuid}}").text(response["message"])
            console.log(response["response"])
            console.log(response["response"]["TestID"])
          }
        };
  });

  function run(testID, ruuid) {
    console.log("exec uuid  :" + execUUIDs[ruuid])
    $.ajax({
      url: 'http://localhost:9000/test/' + testID + '/run', // url where to submit the request
      type : "POST", // type of action POST || GET
      dataType : 'json', // data type
      data : "testID=" + testID,
      success : function(data) {
        if (data["status"] == false) {
            alert(data["message"])
          } else {

          uuid = data["response"]
          var socket = new WebSocket('ws://localhost:9000/websocket/room?room_name=' + uuid)
          output = ""
          socket.onmessage = function(event) {
            output = JSON.parse(event.data)
            console.log("output : " + event.data)
            if (output["status"] == false) {
              $("#save_test_run_error_{{.Uuid}}").show();
              $("#save_test_run_error_{{.Uuid}}").text(output["message"]);
              $( "#panel_test_run_{{.Uuid}}" ).removeClass( "panel-warning" )
              $( "#panel_test_run_{{.Uuid}}" ).addClass( "panel-danger" )


            } else if (output["response"]["event_type"] == "exec_event") {
              output_script_test[{{.Uuid}}].setValue(output_script_test[{{.Uuid}}].getValue() + output["response"]["body"])
              output_script_test[{{.Uuid}}].scrollTo(0, 10000000)
            } else if (output["response"]["event_type"] == "test_event") {
              event_log_editor[{{.Uuid}}].setValue(event_log_editor[{{.Uuid}}].getValue() + output["response"]["body"]["test_log_event"] + "\n")
              event_ref_editor[{{.Uuid}}].setValue(event_ref_editor[{{.Uuid}}].getValue() + output["response"]["body"]["ref_log_event"] + "\n")

              event_log_editor[{{.Uuid}}].scrollTo(0, 10000000)
              event_ref_editor[{{.Uuid}}].scrollTo(0, 10000000)

            } else if (output["response"]["event_type"] == "result_event") {
              $("#save_test_run_success_{{.Uuid}}").show();
              $("#save_test_run_success_{{.Uuid}}").text(output["response"]["body"]);
              $( "#panel_test_run_{{.Uuid}}" ).removeClass( "panel-warning" )
              $( "#panel_test_run_{{.Uuid}}" ).addClass( "panel-success" )
            }
          }
        }
      },
      error: function(xhr, resp, text) {
          console.log(xhr, resp, text);
      }
    });
  }

   $("#run_test_btn_{{.Uuid}}").click(function() {
     $( "#panel_test_run_{{.Uuid}}" ).addClass( "panel-warning" )
     $( "#panel_test_run_{{.Uuid}}" ).removeClass( "panel-success panel-danger" )
      $("#panel_test_run_{{.Uuid}}").slideDown(function() {
        $("#save_test_run_success_{{.Uuid}}").hide();
        $("#save_test_run_error_{{.Uuid}}").hide();

        output_script_test[{{.Uuid}}].setValue("")
        event_log_editor[{{.Uuid}}].setValue("")
        event_ref_editor[{{.Uuid}}].setValue("")

       output_script_test[{{.Uuid}}].refresh()
       event_log_editor[{{.Uuid}}].refresh()
       event_ref_editor[{{.Uuid}}].refresh()
       $("#exit_test_btn_{{.Uuid}}").slideDown(function() {
         run({{.TestID}}, {{.Uuid}});
       });
      });
   });

   $("#exit_test_btn_{{.Uuid}}").click(function() {
     $("#panel_test_run_{{.Uuid}}").slideUp();
     $("#exit_test_btn_{{.Uuid}}").slideUp()
   });

   $("#history_test_btn_{{.Uuid}}").click(function() {
       $.get( "/test/{{.TestID}}/history_template?testID={{.TestID}}", function(data) {
          console.log("#history_panel_{{.Uuid}}")
          console.log("#history_panel_body_{{.Uuid}}")

           $("#history_panel_{{.Uuid}}").slideDown();
           $("#history_panel_body_{{.Uuid}}").html(data)
       });
   });


   $("#save_test_btn_{{.Uuid}}").click(function() {
     $("#save_test_error_{{.Uuid}}").hide()
     $("#save_test_success_{{.Uuid}}").hide()

     var data = {
       name : $("#test_name_{{.Uuid}}").val(),
       config : config_editor[{{.Uuid}}].getValue(),
       path_log : $("#log_event_file_{{.Uuid}}").val(),
       log_events : $("#log_event_ref_file_{{.Uuid}}").val(),
       executionID : executionIDs[{{.Uuid}}],
     };

         // construct an HTTP request
       var xhr = new XMLHttpRequest();
       xhr.open("PUT", 'http://localhost:9000/test/' + {{.TestID}} + "?id_test="+ {{.TestID}}, true);
       xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

       // send the collected data as JSON
       xhr.send(JSON.stringify(data));

       xhr.onloadend = function () {
         response = JSON.parse(xhr.responseText);
         if (response["status"] != true) {

           $("#save_test_error_{{.Uuid}}").slideDown()
           $("#save_test_error_{{.Uuid}}").text(response["message"])
         } else {
           $("#save_test_success_{{.Uuid}}").slideDown()
           $("#save_test_success_{{.Uuid}}").text(response["response"])
           console.log(response["response"])
         }
       };
   });

   $("#delete_test_btn_{{.Uuid}}").click(function(){
     $.ajax({
         url: '/test/' + {{.TestID}} + "?id_test=" + {{.TestID}},
         type: 'DELETE',
         success: function(result) {
           if (result["status"] != true) {

             $("#save_test_error_{{.Uuid}}").slideDown()
             $("#save_test_error_{{.Uuid}}").text(result["message"])
           } else {
             $("#panel_test_infos_{{.Uuid}}").remove()
           }
             // Do something with the result
         }
     });
   });

    //Line number is zero based index
  //  var actualLineNumber = 2;

    //Select editor loaded in the DOM

  //Write the item to the console window, for debugging
    //Set line CSS class to the line number & affecting the background of the line with the css class of line-error
    //config_editor[2].addLineClass(actualLineNumber, 'background', 'line-error');

  if ({{.TestID}} == 0) {
      $(".run_test_btn").hide();
      $(".delete_test_btn").hide();
      $(".save_test_btn").hide();
      $("#history_test_btn_{{.Uuid}}").hide();
  } else {
    $(".create_test_btn").hide();
  }
});

//

// //

</script>
