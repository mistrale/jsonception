{{set_exec_uuid . }}
<div class="panel panel-info panel_exec" id=panel_exec_{{.Uuid}}_{{.ExecutionID}}>
  <div class="panel-heading" id=>
    {{if eq .ExecutionID 0}}
    <h4 class="panel-title">
      <a  id=collapser_exec_{{.Uuid}} style="background-color:transparent;"><span>New template execution</span></a>
    </h4>    {{else}}
    <h4 class="panel-title">
      <a  id=collapser_exec_{{.Uuid}} style="background-color:transparent;"><span>{{.Name}}</span></a>
    </h4>
    {{end}}
  </div>
  {{if eq .ExecutionID 0}}
  <div id="collapse_exec_{{.Uuid}}">
  {{else}}
  <div id="collapse_exec_{{.Uuid}}" class="panel-collapse" style="display:none;">
  {{end}}
    <div class="panel-body">
      <div class="form-group">
        <div id=exec_div_select>
          <div class="form-group">
            <label>Name</label>
            <input required id=exec_name_{{.Uuid}} type="text" class="form-control" value="{{.Name}}">
          </div>
          <div class="form-group">
            <div class="form-group">
              <label>Script</label>
            </div>
            <textarea id=script_area_{{.Uuid}}>{{.Script}}</textarea>
          </div>

          <div class="form-group">
            <div class="panel panel-warning" id=output_exec_{{.Uuid}} style="display:none;">
              <div class="panel-heading">Output</div>
              <div class="panel-body">
                <textarea id=output_script_area_{{.Uuid}}></textarea>
              </div>
            </div>
          </div>

          <div class="form-group">
            <p class="buttons">
              <button id=save_btn_{{.Uuid}} class="save_exec_btn btn btn-primary" style="display:none;">Save execution</button>
              <button id=create_btn_{{.Uuid}} class="save_exec_btn btn btn-primary">Create execution</button>
              <button id=run-btn_{{.Uuid}} class="run_exec_btn btn btn-success">Run execution</button>
              <button id=clear_exec_btn_{{.Uuid}} class="clear_exec_btn btn btn-warning">Clear script</button>
              <button id=clear_history_btn_{{.Uuid}} class="clear_history_btn btn btn-warning">Clear history</button>
              <button id=delete_btn_{{.Uuid}} class="delete_btn btn btn-danger">Delete</button>
            </p>
          </div>
          <div class="form-group" >
            <ul class="list-group">
              <li id=save_error_{{.Uuid}} style="display:none;"  class="list-group-item list-group-item-danger"></li>
              <li id=save_success_{{.Uuid}}  style="display:none;" class="list-group-item list-group-item-success"></li>
            </ul>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
var script_editor = {}
var output_script_editor = {}
var Uuids = []
var queues = {}
var timers = {}
var isFinished = {}

$(document).ready(function() {
  if ({{.ExecutionID}} == 0) {
    $("#save_btn_{{.Uuid}}").hide();
    $("#delete_btn_{{.Uuid}}").hide();
  } else {
    $("#create_btn_{{.Uuid}}").hide()
  }

  script_editor[{{.Uuid}}] = CodeMirror.fromTextArea(document.getElementById("script_area_{{.Uuid}}"), {
    lineNumbers: true,
    theme:"mdn-like",
    mode: "text/x-sh",
    styleActiveLine:true,
    matchBrackets: true
    });

  output_script_editor[{{.Uuid}}] = CodeMirror.fromTextArea(document.getElementById("output_script_area_{{.Uuid}}"), {
    matchBrackets: true,
    theme:"mdn-like",
    lineNumbers: true,
    styleActiveLine:true
    });

    $("#collapser_exec_{{.Uuid}}").on('click', function() {
      $("#collapse_exec_{{.Uuid}}").toggle()
      script_editor[{{.Uuid}}].refresh()
      output_script_editor[{{.Uuid}}].refresh()
    });

    $("#create_btn_{{.Uuid}}").click(function() {
      $("#save_error_{{.Uuid}}").hide()
      $("#save_success_{{.Uuid}}").hide()

      var data = {
        name : $("#exec_name_{{.Uuid}}").val(),
        script : script_editor[{{.Uuid}}].getValue(),
      };

          // construct an HTTP request
        var xhr = new XMLHttpRequest();
        xhr.open("POST", 'http://{{getIP}}:9000/execution/', true);
        xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

        // send the collected data as JSON
        xhr.send(JSON.stringify(data));

        xhr.onloadend = function () {
          response = JSON.parse(xhr.responseText);
          if (response["status"] != true) {
            $("#save_error_{{.Uuid}}").slideDown()
            $("#save_error_{{.Uuid}}").text(response["message"])
          } else {
            $("#save_success_{{.Uuid}}").slideDown()
            $("#save_success_{{.Uuid}}").text(response["message"])
            console.log(response["response"])
          }
        };
    });

    $("#save_btn_{{.Uuid}}").click(function() {
      var data = {
        Name : $("#exec_name_{{.Uuid}}").val(),
        Script : script_editor[{{.Uuid}}].getValue(),
        ExecutionID : {{.ExecutionID}}
      };

          // construct an HTTP request
        var xhr = new XMLHttpRequest();
        xhr.open("PUT", 'http://{{getIP}}:9000/execution/' + {{.ExecutionID}}  + "?id_exec=" + {{.ExecutionID}}, true);
        xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

        // send the collected data as JSON
        xhr.send(JSON.stringify(data));

        xhr.onloadend = function () {
          response = JSON.parse(xhr.responseText);
          if (response["status"] != true) {

            $("#save_error_{{.Uuid}}").slideDown()
            $("#save_error_{{.Uuid}}").text(response["message"])
          } else {
            $("#save_success_{{.Uuid}}").slideDown()
            $("#save_success_{{.Uuid}}").text(response["response"])
            console.log(response)
          }
        };
    });

    $("#delete_btn_{{.Uuid}}").click(function(){
      $.ajax({
          url: '/execution/' + {{.ExecutionID}} + "?id_exec=" + {{.ExecutionID}},
          type: 'DELETE',
          success: function(result) {
            if (result["status"] != true) {

              $("#save_error_{{.Uuid}}").slideDown()
              $("#save_error_{{.Uuid}}").text(result["message"])
            } else {
              $("#panel_exec_{{.Uuid}}_{{.ExecutionID}}").remove()
            }
              // Do something with the result
          }
      });
    });

    $("#run-btn_{{.Uuid}}").click(function(){
      $("#save_error_{{.Uuid}}").slideUp()
      $("#save_success_{{.Uuid}}").slideUp()

      $.getJSON( "http://{{getIP}}:9000/execution/run?id_exec=" + encodeURIComponent({{.ExecutionID}}) + "&script=" + encodeURIComponent(script_editor[{{.Uuid}}].getValue()), function(data) {
        if (data["success"] == false) {
          alert(data["message"])
        } else {
          $("#output_exec_{{.Uuid}}").slideDown()
          output_script_editor[{{.Uuid}}].refresh()
          room_Uuid = data["response"]

          var socket = new WebSocket('ws://{{getIP}}:9000/websocket/room?room_name=' + room_Uuid)
          isFinished[{{.Uuid}}] = false

          queues[{{.Uuid}}] = []

          timers[{{.Uuid}}] = window.setInterval(function() {
            if (queues[{{.Uuid}}].length > 0) {
              var i = queues[{{.Uuid}}].shift();
              console.log("avant")
              console.log(output_script_editor[{{.Uuid}}].getCursor())
              cursor = output_script_editor[{{.Uuid}}].getCursor()
              if (cursor.ch >= 120) {
                cursor.ch = 0
                i += "\n"
              }
              output_script_editor[{{.Uuid}}].replaceRange(i, cursor)
              console.log("apres")

              console.log(cursor)
              output_script_editor[{{.Uuid}}].scrollTo(0, 10000000)
            }
            if (isFinished[{{.Uuid}}] == true && queues[{{.Uuid}}].length == 0) {
              window.clearInterval(timers[{{.Uuid}}]);
            }
          }, 0.1 );

               // Message received on the socket
          output = ""
          socket.onmessage = function(event) {
            output = JSON.parse(event.data)
            console.log(event.data)

            if (output["status"] == false) {
              alert(output["message"])
              isFinished[{{.Uuid}}] = true
            } else if (output["response"]["body"] && output["response"]["event_type"] != "result_exec") {
              console.log("on push dans la queue : " + output["response"]["body"].match(/[\s\S]{1,1000}/g))
              new_array = output["response"]["body"].match(/[\s\S]{1,1000}/g)
              for (var i = 0; i < new_array.length; i++) {
                queues[{{.Uuid}}].push(new_array[i])
              }
              //queues[{{.Uuid}}].push(output["response"]["body"]);
            } else if (output["response"]["event_type"] == "result_exec") {
              isFinished[{{.Uuid}}] = true

              if (output["status"] != true) {

                $("#save_error_{{.Uuid}}").slideDown()
                $("#save_error_{{.Uuid}}").text(output["message"])
              } else {
                $("#save_success_{{.Uuid}}").slideDown()
                $("#save_success_{{.Uuid}}").text("Execution done !")
              }
            }
          }
        }
      });
    });

    $("#save_btn_{{.Uuid}}").click(function(){
    });

    $("#clear_exec_btn_{{.Uuid}}").click(function() {
      script_editor[{{.Uuid}}].setValue("")
    });

    $("#clear_history_btn_{{.Uuid}}").click(function() {
      $("#output_exec_{{.Uuid}}").slideUp()
      output_script_editor[{{.Uuid}}].setValue("")
    });
});
</script>
