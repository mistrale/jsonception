<div class="panel panel-info" id=panel_exec_{{.ExecutionID}}>
  <div class="panel-heading" id=>
    {{if eq .ExecutionID 0}}
    <h4 class="panel-title">
      <a  id=collapser_exec style="background-color:transparent;"><span>New execution</span></a>
    </h4>    {{else}}
    <h4 class="panel-title">
      <a  id=collapser_exec style="background-color:transparent;"><span>{{.Name}}</span></a>
    </h4>
    {{end}}
  </div>
  {{if eq .ExecutionID 0}}
  <div id="collapse_exec">
  {{else}}
  <div id="collapse_exec" class="panel-collapse" style="display:none;">
  {{end}}
    <div class="panel-body">
      <div class="form-group">
        <div id=exec_div_select>
          <div class="form-group">
            <label>Name</label>
            <input required id="exec_name" type="text" class="form-control" value="{{.Name}}">
          </div>
          <div class="form-group">
            <div class="form-group">
              <label>Script</label>
            </div>
            <textarea id=script_area>{{.Script}}</textarea>
          </div>
          <div class="form-group">
            <div class="form-group">
              <label>Output</label>
            </div>
            <textarea id=output_script_area></textarea>
          </div>
          <div class="form-group">
            <p class="buttons">
              <button id=save_btn class="save_exec_btn btn btn-primary">Save execution</button>
              <button id=create_btn class="save_exec_btn btn btn-primary">Create execution</button>
              <button id=run-btn class="run_exec_btn btn btn-success">Run execution</button>
              <button id=clear_exec_btn class="clear_exec_btn btn btn-warning">Clear script</button>
              <button id=clear_history_btn class="clear_history_btn btn btn-warning">Clear history</button>
            </p>
          </div>
          <div class="form-group" >
            <ul class="list-group">
              <li id=save_error style="display:none;"  class="list-group-item list-group-item-danger"></li>
              <li id=save_success  style="display:none;" class="list-group-item list-group-item-success"></li>
            </ul>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
var script_editor = {}
var output_script_editor = {}
var uuids = []
function guid() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
    s4() + '-' + s4() + s4() + s4();
}

$(document).ready(function() {
var uuid = guid()
$("#script_area").attr("id", "script_area_" + uuid)
$("#output_script_area").attr("id", "output_script_area_" + uuid)
$("#exec_name").attr("id", "exec_name_" + uuid)

$("#collapse_exec").attr("id", "collapse_exec_" + uuid)
$("#collapser_exec").attr("id", "collapser_exec_" + uuid)

$("#save_btn").attr("id", "save_btn_" + uuid)
$("#create_btn").attr("id", "create_btn_" + uuid)
$("#run-btn").attr("id", "run-btn_" + uuid)
$("#clear_exec_btn").attr("id", "clear_exec_btn_" + uuid)
$("#clear_history_btn").attr("id", "clear_history_btn_" + uuid)

$("#save_error").attr("id", "save_error_" + uuid)
$("#save_success").attr("id", "save_success_" + uuid)

  if ({{.ExecutionID}} == 0) {
    $("#save_btn_" + uuid).hide();
  } else {
    $("#create_btn_" + uuid).hide()
  }

  script_editor[uuid] = CodeMirror.fromTextArea(document.getElementById("script_area_" + uuid), {
    lineNumbers: true,
    theme:"mdn-like",
    mode: "text/x-sh",
    styleActiveLine:true,
    matchBrackets: true
    });

  output_script_editor[uuid] = CodeMirror.fromTextArea(document.getElementById("output_script_area_" + uuid), {
    matchBrackets: true,
    theme:"mdn-like",
    lineNumbers: true,
    styleActiveLine:true
    });

    $("#collapser_exec_" + uuid).on('click', function() {
      console.log("LOOOOOL : " + this.id.split("_")[2])
      $("#collapse_exec_" + uuid).toggle()
      script_editor[uuid].refresh()
      output_script_editor[uuid].refresh()
    });

    $("#create_btn_" + uuid).click(function() {
      uuid = this.id.split("_")[2]

      $("#save_error_"  + uuid).hide()
      $("#save_success_"  + uuid).hide()

      var data = {
        name : $("#exec_name_" + uuid).val(),
        script : script_editor[uuid].getValue(),
      };

          // construct an HTTP request
        var xhr = new XMLHttpRequest();
        xhr.open("POST", 'http://localhost:9000/execution/', true);
        xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

        // send the collected data as JSON
        xhr.send(JSON.stringify(data));

        xhr.onloadend = function () {
          response = JSON.parse(xhr.responseText);
          if (response["status"] != true) {
            $("#save_error_" + uuid).slideDown()
            $("#save_error_" + uuid).text(response["message"])
          } else {
            $("#save_success_" +  uuid).slideDown()
            $("#save_success_" + uuid).text(response["message"])
            console.log(response["response"])
          }
        };
    });

    $("#run-btn_" + uuid).click(function(){
      console.log("run uuid : " + uuid)
      uuid =this.id.split("_")[1]
      $.getJSON( "/execution/run?id_exec=" + encodeURIComponent({{.ExecutionID}}) + "&script=" + encodeURIComponent(script_editor[uuid].getValue()), function(data) {
        if (data["success"] == false) {
          alert(data["message"])
        } else {

          output_script_editor[uuid].refresh()
          room_uuid = data["response"]
          var socket = new WebSocket('ws://localhost:9000/websocket/room?room_name=' + room_uuid)

               // Message received on the socket
          output = ""
          socket.onmessage = function(event) {
            output = JSON.parse(event.data)
            if (output["status"] == false) {
              alert(output["message"])
            } else if (output["response"]["body"] && output["response"]["body"] != "end_" + room_uuid) {
              output_script_editor[uuid].setValue(output_script_editor[uuid].getValue() + output["response"]["body"])
              output_script_editor[uuid].scrollTo(0, 10000000)
            }
          }
        }
      });
    });

    $("#save_btn_" + uuid).click(function(){
      console.log("run uuid : " + uuid)
      uuid =this.id.split("_")[1]
      $.getJSON( "/execution/test"), function(data) {
        if (data["success"] == false) {
          alert(data["message"])
        } else {
          console.log(data["response"])
        }
      });
    });

    $("#clear_exec_btn_" + uuid).click(function() {
      script_editor[uuid].setValue("")
    });

    $("#clear_history_btn_" + uuid).click(function() {
      output_script_editor[uuid].setValue("")
    });
});
</script>
