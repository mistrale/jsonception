{{set_library_uuid . }}
<div class="panel panel-info" id=panel_library_{{.LibraryID}}>
  <div class="panel-heading" id=>
    {{if eq .LibraryID 0}}
    <h4 class="panel-title">
      <a data-toggle="collapse" href=collapse_library_{{.Uuid}} id=collapser_library_{{.Uuid}} style="background-color:transparent;"><span>New library</span></a>
    </h4>    {{else}}
    <h4 class="panel-title">
      <a data-toggle="collapse" href=collapse_library_{{.Uuid}} id=collapser_library_{{.Uuid}} style="background-color:transparent;"><span>{{.Name}}</span></a>
    </h4>
    {{end}}
  </div>
  {{if eq .LibraryID 0}}
  <div id="collapse_library_{{.Uuid}}">
  {{else}}
  <div id="collapse_library_{{.Uuid}}" class="panel-collapse collapse">
  {{end}}
    <div class="panel-body">
      <div class="form-group">
        <label>Name</label>
        <input required id=library_name_{{.Uuid}} type="text" class="form-control" value="{{.Name}}">
      </div>
      <div class="form-group">
        <label for="sel1">Select test:</label>
        <select class="form-control" id="select_library_{{.Uuid}}">
          <option val="0"></option>
        </select>
        <div id=add_test_{{.Uuid}} style="margin-top:20px;"></div>
        <button  class="btn btn-primary" id=add_btn_test_{{.Uuid}}>Add test</button>
      </div>
      <div class="row" style="margin-top:20px;">
        <div class="col-lg-12">
          <div class="panel panel-warning">
            <div class="panel-heading">Test</div>
              <div class="panel-body" id=panel_test_library_{{.Uuid}}>
                {{range .Tests}}
                <div id=panel_one_test_{{.Uuid}}_{{.TestID}}>
                  <div class="col-lg-11">
                  {{template "Tests/test.html" .}}
                  </div>
                  <div class="col-lg-1">
                    <button class="btn btn-danger" id=remove_test_from_list_btn_{{.Uuid}}_{{.TestID}}>Remove</button>
                  </div>
                {{end}}
              </div>
            </div>
          </div>
      </div>
      <!-- output de test -->
      <div class="row">
        <div class="col-lg-12">
          <div class="panel panel-warning" id=panel_lib_run_{{.Uuid}} style=" margin-top:20px;">
            <div class="panel-heading">
              <h3 class="panel-title"><i class="fa fa-clock-o fa-fw"></i>{{.Name}} run</h3>
            </div>
            <div class="panel-body">
              <div class="row">
                <div  class="col-sm-12">
                  <button onclick="move()">Click Me</button>

                  <div id="myProgress">
                    <div id="myBar">
                      <div id="label">10%</div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Output execution</label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div  class="col-sm-6">
                  <div class="form-group">
                    <label>Log reference</label>
                  </div>
                </div>
                <div  class="col-sm-6">
                  <div class="form-group">
                    <label>Log test</label>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <ul class="list-group">
                    <li id=save_lib_run_error_{{.Uuid}}  style="display:none;" class="list-group-item list-group-item-danger"></li>
                    <li id=save_lib_run_success_{{.Uuid}}  style="display:none;" class="list-group-item list-group-item-success"></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <button  class="btn btn-primary create_btn" id=create_btn_library_{{.Uuid}}>Create</button>
        <button  class="btn btn-primary update_btn" id=update_btn_library_{{.Uuid}}>Update</button>
        <button  class="btn btn-success run_btn" id=run_btn_library_{{.Uuid}}>Run</button>
        <button  class="btn btn-warning history_btn" id=run_btn_library_{{.Uuid}}>See history</button>
        <button  class="btn btn-danger delete_btn" id=run_btn_library_{{.Uuid}}>Delete</button>
      </div>
      <ul class="list-group">
        <li id=save_library_error_{{.Uuid}} style="display:none;" class="list-group-item list-group-item-danger"></li>
        <li id=save_library_success_{{.Uuid}} style="display:none;"  class="list-group-item list-group-item-success"></li>
      </ul>
    </div>
  </div>
</div>
<style>
#myProgress {
    position: relative;
    width: 100%;
    height: 30px;
    background-color: #ddd;
}
#myBar {
    position: absolute;
    width: 1%;
    height: 100%;
    background-color: #5cb85c;
}
/* If you want the label inside the progress bar */
#label {
    text-align: center; /* If you want to center it */
    line-height: 30px; /* Set the line-height to the same as the height of the progress bar container, to center it vertically */
    color: white;
}
</style>
<script>

function move() {
    var elem = document.getElementById("myBar");
    var width = 10;
    var id = setInterval(frame, 10);
    function frame() {
        if (width >= 100) {
            clearInterval(id);
        } else {
            width++;
            elem.style.width = width + '%';
            document.getElementById("label").innerHTML = width * 1 + '%';
        }
    }
}

var testIDs = {}
var tests

var currentData = {}
var listTests = {}

$(document).ready(function() {
  listTests[{{.Uuid}}] = []
  testIDs[{{.Uuid}}] = 0

  if (!tests) {
    $.ajax({
      dataType: "json",
      url: "http://localhost:9000/test",
      success: function (data) {
        tests = data
        $.each(tests, function(k,v){
          $('#select_library_{{.Uuid}}').append($('<option>', {
                value : v["testID"],
                text: v["name"]
              }))
          });
        }
    });
  } else {
    $.each(tests, function(k,v){
      $('#select_library_{{.Uuid}}').append($('<option>', {
            value : v["testID"],
            text: v["name"]
          }))
      });
  }


  $("#add_btn_test_{{.Uuid}}").click(function() {
    console.log("asdas : "  + testIDs[{{.Uuid}}])

    if (testIDs[{{.Uuid}}] != 0 && $.inArray(testIDs[{{.Uuid}}], listTests[{{.Uuid}}]) == -1) {
      console.log("asdas")
      listTests[{{.Uuid}}].push(testIDs[{{.Uuid}}])
      $("#add_test_{{.Uuid}} .panel").remove()

      $("#panel_test_library_{{.Uuid}}").append('<div id=panel_one_test_{{.Uuid}}_' + testIDs[{{.Uuid}}] + '><div class="col-lg-11">' + currentData[{{.Uuid}}] +
      '</div><div class="col-lg-1"><button class="btn btn-danger" id="remove_test_from_list_btn_{{.Uuid}}_' + testIDs[{{.Uuid}}] +
      '">Remove</button></div></div>')

      $("#remove_test_from_list_btn_{{.Uuid}}_" + testIDs[{{.Uuid}}]).click(function() {
        id = this.id.split('_')[6]
        $("#panel_one_test_{{.Uuid}}_" + id).remove()
        listTests[{{.Uuid}}]=jQuery.grep(listTests[{{.Uuid}}],function(value) {return value != id;})
      });

      $("#remove_test_from_list_btn_{{.Uuid}}_" + testIDs[{{.Uuid}}]).onclick = function () {
        console.log('tata')

      };
      function test() {
        $("#panel_one_test_{{.Uuid}}_" + testIDs[{{.Uuid}}]).remove();
        listTests[{{.Uuid}}] = jQuery.grep(y, function(value) {return value !=  testIDs[{{.Uuid}}];})

      }

      $('#select_library_{{.Uuid}}').val("0")
      testIDs[{{.Uuid}}] = 0
       currentData[{{.Uuid}}] = null
    }


    //$('#select_library_{{.Uuid}}').trigger("change")
  });

  $('#select_library_{{.Uuid}}').on('change', function() {
    $("#add_test_{{.Uuid}} .panel").remove()
    var value = $('#select_library_{{.Uuid}} :selected').text()
    function getElement(element) {
      return element.name == value;
    }
    elem = tests.find(getElement)
    if (!elem) {

      //$("#add_test_{{.Uuid}} .panel").css({"display":"none"});

      testIDs[{{.Uuid}}] = 0
    } else {
      $.ajax({
        url: "http://localhost:9000/test/" + elem.test_id + "/template?testID=" + elem.test_id,
        success: function (data) {
          currentData[{{.Uuid}}] = data
         $("#add_test_{{.Uuid}}").html(data)
      //    $("#add_test_{{.Uuid}} .panel-collapse").css({"display":"block"});
        }
      });
      testIDs[{{.Uuid}}] = elem.test_id
    }
  });

  $("#create_btn_library_{{.Uuid}}").click(function() {
     $("#save_library_error_{{.Uuid}}").hide()
     $("#save_library_success_{{.Uuid}}").hide()

      var data = {
        name : $("#library_name_{{.Uuid}}").val(),
        test_ids : listTests[{{.Uuid}}],
      };

          // construct an HTTP request
        var xhr = new XMLHttpRequest();
        xhr.open("POST", 'http://localhost:9000/libraries/', true);
        xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');

        // send the collected data as JSON
        xhr.send(JSON.stringify(data));

        xhr.onloadend = function () {
          response = JSON.parse(xhr.responseText);
          console.log(response);
          if (response["status"] != true) {

            $("#save_library_error_{{.Uuid}}").slideDown()
            $("#save_library_error_{{.Uuid}}").text(response["message"])
          } else {
            $("#save_library_success_{{.Uuid}}").slideDown()
            $("#save_library_success_{{.Uuid}}").text(response["message"])
            console.log(response["response"])
            console.log(response["response"]["TestID"])
          }
        };
  });

  $("#collapser_library_{{.Uuid}}").on('click', function() {
    $("#collapse_library_{{.Uuid}}").toggle()
  });

  function run(libID) {
    //console.log("exec uuid  :" + execUUIDs[ruuid])
    $.ajax({
      url: 'http://localhost:9000/libraries/' + libID + '/run', // url where to submit the request
      type : "POST", // type of action POST || GET
      dataType : 'json', // data type
      data : "libID=" + libID,
      success : function(data) {
        console.log(data)

        if (data["status"] == false) {
            alert(data["message"])
          } else {
            uuid = data["response"]
            var socket = new WebSocket('ws://localhost:9000/websocket/room?room_name=' + uuid)
            output = ""
            socket.onmessage = function(event) {
              console.log(event.data)

              //output = JSON.parse(event.data)
            //  console.log(output)
            }
        }
      },
      error: function(xhr, resp, text) {
          console.log(xhr, resp, text);
      }
    });
  }

  $("#run_btn_library_{{.Uuid}}").click(function() {
      run({{.LibraryID}});
      move()
     });
  });
</script>
